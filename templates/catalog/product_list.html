{% extends 'base.html' %}
{% load static %}

{% block title %}Каталог памятников - Finalis{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/catalog.css">
{% endblock %}

{% block content %}
<div class="catalog-page">
    <!-- Hero Section для каталога -->
    <section class="hero-section">
        <div class="container">
            <h1 class="hero-title">Каталог памятников</h1>
            <p class="hero-subtitle">Найдите идеальный памятник среди тысяч вариантов</p>
        </div>
    </section>

    <!-- Панель инструментов -->
    <div class="toolbar">
        <div class="results-count">
            Найдено товаров: <strong>{{ products|length }}</strong>
        </div>
        <div class="sort-filter-controls">
            <select class="sort-select" onchange="window.location.href = '?sort=' + this.value">
                <option value="-created_at" {% if request.GET.sort == '-created_at' %}selected{% endif %}>По новизне</option>
                <option value="price" {% if request.GET.sort == 'price' %}selected{% endif %}>По цене (возр.)</option>
                <option value="-price" {% if request.GET.sort == '-price' %}selected{% endif %}>По цене (убыв.)</option>
                <option value="-rating" {% if request.GET.sort == '-rating' %}selected{% endif %}>По рейтингу</option>
            </select>
            <button class="toggle-filters" id="toggleFilters">
                <i class="bi bi-funnel"></i>
                Фильтры
            </button>
        </div>
    </div>

    <!-- Фильтры -->
    <div class="filters-container" id="filtersContainer">
        <div class="filters">
            <div class="filters-header">
                <h3>Фильтры</h3>
                <button class="close-filters" id="closeFilters">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <form method="get" id="filterForm">
                <!-- Город -->
                <div class="filter-group">
                    <h3><i class="bi bi-geo-alt"></i>Город</h3>
                    <select name="city" class="filter-select">
                        <option value="">Все города</option>
                        {% for city in cities %}
                            <option value="{{ city.id }}" {% if request.GET.city == city.id|stringformat:"i" %}selected{% endif %}>
                                {{ city.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Материал -->
                <div class="filter-group">
                    <h3><i class="bi bi-gem"></i>Материал</h3>
                    <div class="filter-options">
                        {% for material_value, material_name in material_choices %}
                            <label class="filter-checkbox">
                                <input type="checkbox" name="material" value="{{ material_value }}"
                                       {% if material_value in selected_materials %}checked{% endif %}>
                                {{ material_name }}
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Форма -->
                <div class="filter-group">
                    <h3><i class="bi bi-shapes"></i>Форма</h3>
                    <div class="filter-options">
                        {% for shape_value, shape_name in shape_choices %}
                            <label class="filter-checkbox">
                                <input type="checkbox" name="shape" value="{{ shape_value }}"
                                       {% if shape_value in selected_shapes %}checked{% endif %}>
                                {{ shape_name }}
                            </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Цена -->
                <div class="filter-group">
                    <h3><i class="bi bi-currency-dollar"></i>Цена (₽)</h3>
                    <div class="price-range">
                        <input type="number" name="min_price" placeholder="От"
                               value="{{ request.GET.min_price }}" min="0" class="form-input">
                        <input type="number" name="max_price" placeholder="До"
                               value="{{ request.GET.max_price }}" min="0" class="form-input">
                    </div>
                </div>

                <button type="submit" class="apply-filters">
                    <i class="bi bi-check-lg"></i>
                    Применить фильтры
                </button>
                <button type="button" onclick="window.location.href='{% url 'catalog' %}'" class="btn-secondary" style="width: 100%; margin-top: 10px;">
                    <i class="bi bi-arrow-clockwise"></i>
                    Сбросить фильтры
                </button>
            </form>
        </div>
    </div>

    <!-- Сетка товаров -->
    <section class="catalog">
        {% for product in products %}
            <!-- Обновляем карточку товара -->
<div class="product-card">
    <!-- Кликабельная область карточки -->
    <a href="{% url 'product_detail' product.id %}" class="product-card-link" style="text-decoration: none; color: inherit;">
        <div class="product-image">
            {% if product.images.first %}
                <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}">
            {% else %}
                <div class="no-image">
                    <i class="bi bi-image"></i>
                    <span>Нет изображения</span>
                </div>
            {% endif %}
        </div>
    </a>

    <div class="product-info">
        <a href="{% url 'product_detail' product.id %}" style="text-decoration: none; color: inherit;">
            <h3 class="product-title">{{ product.name }}</h3>
        </a>

        <p class="product-supplier">
            <i class="bi bi-building"></i>
            {{ product.supplier.company_name }}
        </p>

        <div class="product-specs">
            <span class="spec-badge">{{ product.get_material_display }}</span>
            <span class="spec-badge">{{ product.height }}×{{ product.width }} см</span>
        </div>

        <div class="product-price">
            {% if product.discount_price %}
                <span class="old-price">{{ product.price }} ₽</span>
                <span class="current-price">{{ product.discount_price }} ₽</span>
            {% else %}
                <span class="current-price">{{ product.price }} ₽</span>
            {% endif %}
        </div>

        <div class="product-actions">
            <form action="{% url 'add_to_cart' product.id %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn-primary">
                    <i class="bi bi-cart-plus"></i>
                    В корзину
                </button>
            </form>

            <!-- Работающее избранное -->
            {% if user.is_authenticated %}
                {% if product.id in favorite_ids %}
                <form action="{% url 'remove_from_favorites' product.id %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-secondary" style="color: #667eea;">
                        <i class="bi bi-heart-fill"></i>
                    </button>
                </form>
                {% else %}
                <form action="{% url 'add_to_favorites' product.id %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-secondary">
                        <i class="bi bi-heart"></i>
                    </button>
                </form>
                {% endif %}
            {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" class="btn-secondary">
                    <i class="bi bi-heart"></i>
                </a>
            {% endif %}
        </div>
    </div>
</div>

<style>
.product-card {
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.product-card-link {
    display: block;
}
</style>
        {% empty %}
            <div class="no-products">
                <i class="bi bi-search"></i>
                <h3>Товары не найдены</h3>
                <p>Попробуйте изменить параметры фильтрации</p>
                <a href="{% url 'catalog' %}" class="btn-primary">Сбросить фильтры</a>
            </div>
        {% endfor %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/simple.js"></script>
{% endblock %}